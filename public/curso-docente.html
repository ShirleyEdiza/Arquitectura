// En curso-docente.html - REEMPLAZA el script actual por este:
document.addEventListener('DOMContentLoaded', async () => {
    // --- 1. Conexión y Elementos ---
    const socket = io('http://192.168.100.41:3002');
    
    const modal = document.getElementById('modal-publicar');
    const modalTitulo = document.getElementById('modal-titulo');
    const btnCerrar = document.querySelector('.modal-close');
    const btnAbrirModal = document.getElementById('btn-abrir-modal');
    const form = document.getElementById('form-tarea');
    const selectCurso = document.getElementById('select-curso');
    const inputTitulo = document.getElementById('input-titulo');
    const statusDiv = document.getElementById('status');
    const tituloCursoH1 = document.getElementById('titulo-curso');
    const activityList = document.getElementById('activity-list');
    
    let cursoIdGlobal = '';
    let cursoNombreGlobal = '';

    // --- 2. Lógica al Cargar la Página ---
    const params = new URLSearchParams(window.location.search);
    const cursoId = params.get('curso');
    const cursoNombre = params.get('nombre');
    
    if (!cursoId || !cursoNombre) {
        if (tituloCursoH1) tituloCursoH1.textContent = "Error: Curso no encontrado";
        if (btnAbrirModal) btnAbrirModal.disabled = true;
        return; 
    }
    
    cursoIdGlobal = cursoId; 
    cursoNombreGlobal = cursoNombre;
    tituloCursoH1.textContent = `Gestionar: ${cursoNombre}`;
    modalTitulo.textContent = `Publicar en: ${cursoNombre}`;
    selectCurso.innerHTML = `<option value="1">${cursoNombre}</option>`;

    // Cargar tareas existentes
    await cargarTareasExistentes();

    // --- 3. Lógica Modal ---
    if (btnAbrirModal) {
        btnAbrirModal.addEventListener('click', () => { 
            modal.style.display = 'flex'; 
        });
    }
    
    const cerrarModal = () => {
        modal.style.display = 'none';
        if (form) form.reset();
    }
    if (btnCerrar) btnCerrar.addEventListener('click', cerrarModal);
    if (modal) {
        modal.addEventListener('click', (e) => {
            if (e.target === modal) {
                cerrarModal();
            }
        });
    }

    // --- 4. Lógica de Publicar Tarea - CONEXIÓN REAL AL BACKEND ---
    if (form) {
        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!inputTitulo.value.trim()) { 
                alert("El título es obligatorio."); 
                return; 
            }
            
            const fecha = document.getElementById('input-fecha').value;
            const hora = document.getElementById('input-hora').value;
            const descripcion = document.getElementById('input-desc').value;
            
            try {
                if (statusDiv) statusDiv.textContent = "⏳ Publicando tarea...";
                
                // Crear tarea en el backend
                const resultado = await window.apiService.crearTarea({
                    titulo: inputTitulo.value,
                    descripcion: descripcion,
                    fecha_limite: fecha || null,
                    hora_limite: hora || null,
                    archivo_material: null, // Por ahora sin archivo
                    id_curso: 1 // ID fijo por simplicidad
                });
                
                if (statusDiv) statusDiv.textContent = "✅ Tarea publicada exitosamente";
                
                // También emitir via socket para notificaciones en tiempo real
                socket.emit('publicar-tarea', {
                    sala: cursoIdGlobal,
                    titulo: inputTitulo.value,
                    descripcion: descripcion,
                    fechaLimite: fecha ? new Date(`${fecha}T${hora}:00`).toISOString() : null,
                    cursoNombre: cursoNombreGlobal
                });
                
                // Agregar a la lista local
                mostrarTareaPublicada({
                    titulo: inputTitulo.value,
                    descripcion: descripcion,
                    fecha_limite: fecha,
                    hora_limite: hora,
                    nombre_curso: cursoNombreGlobal
                });
                
                setTimeout(cerrarModal, 1500);
                
            } catch (error) {
                console.error('Error al publicar tarea:', error);
                if (statusDiv) statusDiv.textContent = "❌ Error al publicar tarea";
            }
        });
    }

    // --- 5. Función para Cargar Tareas Existentes ---
    async function cargarTareasExistentes() {
        try {
            const tareas = await window.apiService.obtenerTareasPorCurso(1); // ID del curso
            
            if (activityList && tareas.length > 0) {
                activityList.innerHTML = '';
                tareas.forEach(tarea => {
                    mostrarTareaPublicada(tarea);
                });
            }
        } catch (error) {
            console.error('Error al cargar tareas:', error);
        }
    }

    // --- 6. Función para Dibujar Tarea ---
    function mostrarTareaPublicada(data) {
        let iconClass = 'fas fa-clipboard-list';
        if (data.titulo.toLowerCase().includes('aviso')) { 
            iconClass = 'fas fa-bullhorn'; 
        }

        let fecha = 'No especificada';
        if (data.fecha_limite) { 
            const fechaObj = new Date(data.fecha_limite + (data.hora_limite ? `T${data.hora_limite}` : ''));
            fecha = fechaObj.toLocaleString('es-EC', { 
                dateStyle: 'long', 
                timeStyle: data.hora_limite ? 'short' : undefined
            }); 
        }
        
        const tareaEl = document.createElement('li');
        tareaEl.className = 'activity-item';
        
        tareaEl.innerHTML = `
            <div class="activity-icon"><i class="${iconClass}"></i></div>
            <div class="activity-content">
                <span class="activity-title">${data.titulo}</span>
                <p class="activity-description">${data.descripcion || "Sin descripción."}</p>
                <div class="activity-meta"><strong>Fecha Límite:</strong> ${fecha}</div>
                <div class="activity-meta"><strong>Curso:</strong> ${data.nombre_curso || cursoNombreGlobal}</div>
            </div>`;
        
        if (activityList) activityList.prepend(tareaEl);
    }

    // --- 7. Lógica "Escribiendo..." ---
    if (inputTitulo) {
        inputTitulo.addEventListener('keyup', () => {
            socket.emit('docente-escribiendo', { sala: cursoIdGlobal });
        });
    }

    // --- 8. LÓGICA DEL BOTÓN SALIR ---
    const userAvatar = document.getElementById('user-avatar');
    const userMenu = document.getElementById('user-menu');
    const logoutBtn = document.getElementById('logout-btn');

    if (userAvatar && userMenu && logoutBtn) {
        userAvatar.addEventListener('click', (e) => {
            e.stopPropagation(); 
            userMenu.classList.toggle('show');
        });
        logoutBtn.addEventListener('click', () => {
            window.location.href = 'login.html';
        });
    }
    
    window.addEventListener('click', (e) => {
        if (userMenu && userMenu.classList.contains('show')) {
            if (userAvatar && !userAvatar.contains(e.target)) {
                userMenu.classList.remove('show');
            }
        }
    });

});